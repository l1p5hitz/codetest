#include "Si7021_cal.h"
#include "Si7021_driver.h"
#include "main.h"
#include "define.h"
#include "cmsis_os.h"
#include "STM32g0xx_hal_iwdg.h"
#include "stm32g0xx_hal_gpio.h"


#define ADC1_DR_Address    ((u32)0x40012400+0x4c)

#define LOADING_STATUS_NL 1
#define LOADING_STATUS_1L 2
#define LOADING_STATUS_2L 3

#ifdef BROAN_BRNC011
#define NTC1_SMOOTH_SAMPLE_SIZE 3 * 5
#define TEMP_DELTA_SMOOTH_SAMPLE_SIZE 24* 5
#endif

#ifdef BROAN_BRNC021
#define NTC1_SMOOTH_SAMPLE_SIZE 64 
#define TEMP_DELTA_SMOOTH_SAMPLE_SIZE 64
#endif

extern uint8_t ThreeSecTick;

typedef struct
{
  float T_DeltaBase;
  float T_Y_EachBrightLvDelta;
  float T_G_EachBrightLvDelta;
  float T_X;
  float H_DeltaBase;
  float H_EachBrightLvDelta;
}TH_Formula_Factor_t;

TH_Formula_Factor_t RS_NL;
TH_Formula_Factor_t RS_FL;
TH_Formula_Factor_t WC_NL;
TH_Formula_Factor_t WC_HL;
TH_Formula_Factor_t WC_FL;

float WC_T_Delta_Smooth_up;
float WC_T_Delta_Smooth_dn;

/* Private variables ---------------------------------------------------------*/


uint16_t saturational_pressure_table[] = { [0] = 611,
                                                        [1] = 615,
                                                        [2] = 620,
                                                        [3] = 624,
                                                        [4] = 629,
                                                        [5] = 633,
                                                        [6] = 638,
                                                        [7] = 643,
                                                        [8] = 647,
                                                        [9] = 652,
                                                        [10] = 657,
                                                        [11] = 661,
                                                        [12] = 666,
                                                        [13] = 671,
                                                        [14] = 676,
                                                        [15] = 681,
                                                        [16] = 686,
                                                        [17] = 691,
                                                        [18] = 696,
                                                        [19] = 701,
                                                        [20] = 706,
                                                        [21] = 711,
                                                        [22] = 716,
                                                        [23] = 721,
                                                        [24] = 726,
                                                        [25] = 731,
                                                        [26] = 736,
                                                        [27] = 742,
                                                        [28] = 747,
                                                        [29] = 752,
                                                        [30] = 758,
                                                        [31] = 763,
                                                        [32] = 769,
                                                        [33] = 774,
                                                        [34] = 780,
                                                        [35] = 785,
                                                        [36] = 791,
                                                        [37] = 796,
                                                        [38] = 802,
                                                        [39] = 808,
                                                        [40] = 813,
                                                        [41] = 819,
                                                        [42] = 825,
                                                        [43] = 831,
                                                        [44] = 836,
                                                        [45] = 842,
                                                        [46] = 848,
                                                        [47] = 854,
                                                        [48] = 860,
                                                        [49] = 866,
                                                        [50] = 872,
                                                        [51] = 878,
                                                        [52] = 885,
                                                        [53] = 891,
                                                        [54] = 897,
                                                        [55] = 903,
                                                        [56] = 909,
                                                        [57] = 916,
                                                        [58] = 922,
                                                        [59] = 929,
                                                        [60] = 935,
                                                        [61] = 942,
                                                        [62] = 948,
                                                        [63] = 955,
                                                        [64] = 961,
                                                        [65] = 968,
                                                        [66] = 975,
                                                        [67] = 981,
                                                        [68] = 988,
                                                        [69] = 995,
                                                        [70] = 1002,
                                                        [71] = 1009,
                                                        [72] = 1016,
                                                        [73] = 1023,
                                                        [74] = 1030,
                                                        [75] = 1037,
                                                        [76] = 1044,
                                                        [77] = 1051,
                                                        [78] = 1058,
                                                        [79] = 1065,
                                                        [80] = 1073,
                                                        [81] = 1080,
                                                        [82] = 1087,
                                                        [83] = 1095,
                                                        [84] = 1102,
                                                        [85] = 1110,
                                                        [86] = 1117,
                                                        [87] = 1125,
                                                        [88] = 1133,
                                                        [89] = 1140,
                                                        [90] = 1148,
                                                        [91] = 1156,
                                                        [92] = 1164,
                                                        [93] = 1171,
                                                        [94] = 1179,
                                                        [95] = 1187,
                                                        [96] = 1195,
                                                        [97] = 1203,
                                                        [98] = 1212,
                                                        [99] = 1220,
                                                        [100] = 1228,
                                                        [101] = 1236,
                                                        [102] = 1244,
                                                        [103] = 1253,
                                                        [104] = 1261,
                                                        [105] = 1270,
                                                        [106] = 1278,
                                                        [107] = 1287,
                                                        [108] = 1295,
                                                        [109] = 1304,
                                                        [110] = 1313,
                                                        [111] = 1321,
                                                        [112] = 1330,
                                                        [113] = 1339,
                                                        [114] = 1348,
                                                        [115] = 1357,
                                                        [116] = 1366,
                                                        [117] = 1375,
                                                        [118] = 1384,
                                                        [119] = 1393,
                                                        [120] = 1402,
                                                        [121] = 1412,
                                                        [122] = 1421,
                                                        [123] = 1430,
                                                        [124] = 1440,
                                                        [125] = 1449,
                                                        [126] = 1459,
                                                        [127] = 1469,
                                                        [128] = 1478,
                                                        [129] = 1488,
                                                        [130] = 1498,
                                                        [131] = 1507,
                                                        [132] = 1517,
                                                        [133] = 1527,
                                                        [134] = 1537,
                                                        [135] = 1547,
                                                        [136] = 1557,
                                                        [137] = 1568,
                                                        [138] = 1578,
                                                        [139] = 1588,
                                                        [140] = 1598,
                                                        [141] = 1609,
                                                        [142] = 1619,
                                                        [143] = 1630,
                                                        [144] = 1640,
                                                        [145] = 1651,
                                                        [146] = 1665,
                                                        [147] = 1673,
                                                        [148] = 1683,
                                                        [149] = 1694,
                                                        [150] = 1705,
                                                        [151] = 1716,
                                                        [152] = 1727,
                                                        [153] = 1738,
                                                        [154] = 1750,
                                                        [155] = 1761,
                                                        [156] = 1772,
                                                        [157] = 1784,
                                                        [158] = 1795,
                                                        [159] = 1807,
                                                        [160] = 1818,
                                                        [161] = 1830,
                                                        [162] = 1842,
                                                        [163] = 1853,
                                                        [164] = 1865,
                                                        [165] = 1877,
                                                        [166] = 1889,
                                                        [167] = 1901,
                                                        [168] = 1913,
                                                        [169] = 1925,
                                                        [170] = 1938,
                                                        [171] = 1950,
                                                        [172] = 1962,
                                                        [173] = 1975,
                                                        [174] = 1987,
                                                        [175] = 2000,
                                                        [176] = 2012,
                                                        [177] = 2025,
                                                        [178] = 2038,
                                                        [179] = 2051,
                                                        [180] = 2064,
                                                        [181] = 2077,
                                                        [182] = 2090,
                                                        [183] = 2103,
                                                        [184] = 2116,
                                                        [185] = 2130,
                                                        [186] = 2143,
                                                        [187] = 2156,
                                                        [188] = 2170,
                                                        [189] = 2184,
                                                        [190] = 2197,
                                                        [191] = 2211,
                                                        [192] = 2225,
                                                        [193] = 2239,
                                                        [194] = 2253,
                                                        [195] = 2267,
                                                        [196] = 2281,
                                                        [197] = 2295,
                                                        [198] = 2309,
                                                        [199] = 2324,
                                                        [200] = 2338,
                                                        [201] = 2353,
                                                        [202] = 2367,
                                                        [203] = 2382,
                                                        [204] = 2397,
                                                        [205] = 2411,
                                                        [206] = 2426,
                                                        [207] = 2441,
                                                        [208] = 2456,
                                                        [209] = 2472,
                                                        [210] = 2487,
                                                        [211] = 2502,
                                                        [212] = 2518,
                                                        [213] = 2533,
                                                        [214] = 2549,
                                                        [215] = 2564,
                                                        [216] = 2580,
                                                        [217] = 2596,
                                                        [218] = 2612,
                                                        [219] = 2628,
                                                        [220] = 2644,
                                                        [221] = 2660,
                                                        [222] = 2676,
                                                        [223] = 2692,
                                                        [224] = 2709,
                                                        [225] = 2725,
                                                        [226] = 2742,
                                                        [227] = 2759,
                                                        [228] = 2775,
                                                        [229] = 2792,
                                                        [230] = 2809,
                                                        [231] = 2826,
                                                        [232] = 2843,
                                                        [233] = 2861,
                                                        [234] = 2878,
                                                        [235] = 2895,
                                                        [236] = 2913,
                                                        [237] = 2930,
                                                        [238] = 2948,
                                                        [239] = 2966,
                                                        [240] = 2984,
                                                        [241] = 3002,
                                                        [242] = 3020,
                                                        [243] = 3038,
                                                        [244] = 3056,
                                                        [245] = 3074,
                                                        [246] = 3093,
                                                        [247] = 3111,
                                                        [248] = 3130,
                                                        [249] = 3149,
                                                        [250] = 3167,
                                                        [251] = 3186,
                                                        [252] = 3205,
                                                        [253] = 3225,
                                                        [254] = 3244,
                                                        [255] = 3263,
                                                        [256] = 3282,
                                                        [257] = 3302,
                                                        [258] = 3322,
                                                        [259] = 3341,
                                                        [260] = 3361,
                                                        [261] = 3381,
                                                        [262] = 3401,
                                                        [263] = 3421,
                                                        [264] = 3441,
                                                        [265] = 3462,
                                                        [266] = 3482,
                                                        [267] = 3503,
                                                        [268] = 3523,
                                                        [269] = 3544,
                                                        [270] = 3565,
                                                        [271] = 3586,
                                                        [272] = 3607,
                                                        [273] = 3628,
                                                        [274] = 3650,
                                                        [275] = 3671,
                                                        [276] = 3692,
                                                        [277] = 3714,
                                                        [278] = 3736,
                                                        [279] = 3758,
                                                        [280] = 3780,
                                                        [281] = 3802,
                                                        [282] = 3824,
                                                        [283] = 3846,
                                                        [284] = 3868,
                                                        [285] = 3891,
                                                        [286] = 3914,
                                                        [287] = 3936,
                                                        [288] = 3959,
                                                        [289] = 3982,
                                                        [290] = 4005,
                                                        [291] = 4028,
                                                        [292] = 4052,
                                                        [293] = 4075,
                                                        [294] = 4099,
                                                        [295] = 4122,
                                                        [296] = 4146,
                                                        [297] = 4170,
                                                        [298] = 4194,
                                                        [299] = 4218,
                                                        [300] = 4243,
                                                        [301] = 4267,
                                                        [302] = 4292,
                                                        [303] = 4316,
                                                        [304] = 4341,
                                                        [305] = 4366,
                                                        [306] = 4391,
                                                        [307] = 4416,
                                                        [308] = 4441,
                                                        [309] = 4467,
                                                        [310] = 4492,
                                                        [311] = 4518,
                                                        [312] = 4544,
                                                        [313] = 4569,
                                                        [314] = 4595,
                                                        [315] = 4622,
                                                        [316] = 4648,
                                                        [317] = 4674,
                                                        [318] = 4701,
                                                        [319] = 4727,
                                                        [320] = 4754,
                                                        [321] = 4781,
                                                        [322] = 4808,
                                                        [323] = 4835,
                                                        [324] = 4863,
                                                        [325] = 4890,
                                                        [326] = 4918,
                                                        [327] = 4946,
                                                        [328] = 4973,
                                                        [329] = 5001,
                                                        [330] = 5030,
                                                        [331] = 5058,
                                                        [332] = 5086,
                                                        [333] = 5115,
                                                        [334] = 5144,
                                                        [335] = 5172,
                                                        [336] = 5201,
                                                        [337] = 5230,
                                                        [338] = 5260,
                                                        [339] = 5289,
                                                        [340] = 5319,
                                                        [341] = 5348,
                                                        [342] = 5378,
                                                        [343] = 5408,
                                                        [344] = 5438,
                                                        [345] = 5469,
                                                        [346] = 5499,
                                                        [347] = 5530,
                                                        [348] = 5560,
                                                        [349] = 5591,
                                                        [350] = 5622,
                                                        [351] = 5653,
                                                        [352] = 5684,
                                                        [353] = 5716,
                                                        [354] = 5748,
                                                        [355] = 5779,
                                                        [356] = 5811,
                                                        [357] = 5843,
                                                        [358] = 5875,
                                                        [359] = 5908,
                                                        [360] = 5940,
                                                        [361] = 5973,
                                                        [362] = 6006,
                                                        [363] = 6039,
                                                        [364] = 6072,
                                                        [365] = 6105,
                                                        [366] = 6139,
                                                        [367] = 6172,
                                                        [368] = 6206,
                                                        [369] = 6240,
                                                        [370] = 6274,
                                                        [371] = 6308,
                                                        [372] = 6343,
                                                        [373] = 6377,
                                                        [374] = 6412,
                                                        [375] = 6447,
                                                        [376] = 6482,
                                                        [377] = 6517,
                                                        [378] = 6553,
                                                        [379] = 6588,
                                                        [380] = 6624,
                                                        [381] = 6660,
                                                        [382] = 6696,
                                                        [383] = 6732,
                                                        [384] = 6769,
                                                        [385] = 6805,
                                                        [386] = 6842,
                                                        [387] = 6879,
                                                        [388] = 6916,
                                                        [389] = 6953,
                                                        [390] = 6991,
                                                        [391] = 7028,
                                                        [392] = 7066,
                                                        [393] = 7104,
                                                        [394] = 7142,
                                                        [395] = 7180,
                                                        [396] = 7219,
                                                        [397] = 7258,
                                                        [398] = 7296,
                                                        [399] = 7336,
                                                        [400] = 7377,
                                                        [401] = 7417,
                                                        [402] = 7456,
                                                        [403] = 7496,
                                                        [404] = 7536,
                                                        [405] = 7576,
                                                        [406] = 7617,
                                                        [407] = 7657,
                                                        [408] = 7698,
                                                        [409] = 7739,
                                                        [410] = 7780,
                                                        [411] = 7821,
                                                        [412] = 7862,
                                                        [413] = 7904,
                                                        [414] = 7946,
                                                        [415] = 7988,
                                                        [416] = 8030,
                                                        [417] = 8073,
                                                        [418] = 8115,
                                                        [419] = 8158,
                                                        [420] = 8201,
                                                        [421] = 8244,
                                                        [422] = 8287,
                                                        [423] = 8331,
                                                        [424] = 8375,
                                                        [425] = 8419,
                                                        [426] = 8463,
                                                        [427] = 8507,
                                                        [428] = 8552,
                                                        [429] = 8597,
                                                        [430] = 8642,
                                                        [431] = 8687,
                                                        [432] = 8732,
                                                        [433] = 8778,
                                                        [434] = 8824,
                                                        [435] = 8870,
                                                        [436] = 8916,
                                                        [437] = 8962,
                                                        [438] = 9009,
                                                        [439] = 9056,
                                                        [440] = 9103,
                                                        [441] = 9150,
                                                        [442] = 9197,
                                                        [443] = 9245,
                                                        [444] = 9293,
                                                        [445] = 9341,
                                                        [446] = 9389,
                                                        [447] = 9438,
                                                        [448] = 9487,
                                                        [449] = 9536,
                                                        [450] = 9585,
                                                        [451] = 9634,
                                                        [452] = 9684,
                                                        [453] = 9734,
                                                        [454] = 9784,
                                                        [455] = 9834,
                                                        [456] = 9884,
                                                        [457] = 9935,
                                                        [458] = 9986,
                                                        [459] = 10037,
                                                        [460] = 10089,
                                                        [461] = 10140,
                                                        [462] = 10192,
                                                        [463] = 10244,
                                                        [464] = 10296,
                                                        [465] = 10349,
                                                        [466] = 10402,
                                                        [467] = 10455,
                                                        [468] = 10508,
                                                        [469] = 10562,
                                                        [470] = 10615,
                                                        [471] = 10669,
                                                        [472] = 10723,
                                                        [473] = 10778,
                                                        [474] = 10832,
                                                        [475] = 10887,
                                                        [476] = 10942,
                                                        [477] = 10998,
                                                        [478] = 11053,
                                                        [479] = 11109,
                                                        [480] = 11165,
                                                        [481] = 11222,
                                                        [482] = 11278,
                                                        [483] = 11335,
                                                        [484] = 11392,
                                                        [485] = 11449,
                                                        [486] = 11507,
                                                        [487] = 11565,
                                                        [488] = 11623,
                                                        [489] = 11681,
                                                        [490] = 11740,
                                                        [491] = 11799,
                                                        [492] = 11858,
                                                        [493] = 11917,
                                                        [494] = 11977,
                                                        [495] = 12036,
                                                        [496] = 12097,
                                                        [497] = 12157,
                                                        [498] = 12217,
                                                        [499] = 12278,
                                                        [500] = 12339, };



static float NTC1_SmoothSample = 24;
static float TempDelta_SmoothSample = 24;
static float NTC_CaledData_last = 0;
static float TempDelta_last = 0;

static uint8_t Loading_Status_forTHcal;
static uint8_t Loading_Status_forTHcal_B4;
static float Curr_LukeDelta = 1;
static float Target_LukeDelta = 1;





extern ADC_HandleTypeDef hadc1;
extern uint8_t HW_VER;
uint32_t adcData[8];

__IO uint16_t ADC_ConvertedValue;		// ADC1 get value by MDA to SRAM

float ADC_ConvertedValueLocal;   		// real value	
uint16_t adcx;


float NTC_MRURATA_NCP18XH103F03RB_cal(uint16_t reading);
void Init_Cal_Data(void); 


 #define HUMIDIY_ADD_DELTA
#define RS_NL_DELTA_025     0.87f
#define RS_NL_DELTA_2535     0.90f

#define RS_FL_DELTA_025     0.87f
#define RS_FL_DELTA_2535     0.90f

#define WC_NL_DELTA_025     0.87f
#define WC_NL_DELTA_2535     0.87f

//#define WC_FL_DELTA_025     0.87f
//#define WC_FL_DELTA_2535     0.87f

#define WC_FL_DELTA_025     0.85f
#define WC_FL_DELTA_2535     0.85f

#define WC_HL_DELTA_025     0.85f
#define WC_HL_DELTA_2535     0.85f

void Init_Cal_Data(void){
  
  Loading_Status_forTHcal = LOADING_STATUS_NL;
  Loading_Status_forTHcal_B4 = LOADING_STATUS_NL;
  //Humidity//
//  RS_NL.H_DeltaBase = 1.0f;     //0.845f;
//  RS_NL.H_EachBrightLvDelta = 0.0f;     //0.002f;
//    RS_NL.H_DeltaBase = 0.87f;     //0.87f;
      RS_NL.H_DeltaBase = RS_NL_DELTA_025;     //0.87f;
    RS_NL.H_EachBrightLvDelta = 0.0f;     //0.002f;

  //Temp//
  RS_NL.T_DeltaBase = 0.54f;    //0.68f;//(0.9-0.02)     //0.54f;    //1.4f;
  RS_NL.T_G_EachBrightLvDelta = 0.02f;
  RS_NL.T_Y_EachBrightLvDelta = 0.03f;
  RS_NL.T_X = 0.0f;     //3.0f;
  
  //Humidity//
//  RS_FL.H_DeltaBase = 1.0f;     //0.845f;
//    RS_FL.H_DeltaBase = 0.87f;     //0.845f;
  RS_FL.H_DeltaBase = RS_FL_DELTA_025;
  RS_FL.H_EachBrightLvDelta = 0.0f;     //0.002f;

  //Temp//
  RS_FL.T_DeltaBase = 0.6f;     //1.5f;
  RS_FL.T_G_EachBrightLvDelta = 0.015;
  RS_FL.T_Y_EachBrightLvDelta = 0.02f;
  RS_FL.T_X = 0.0f;        //4.0f;
  
  //Humidity//
//  WC_NL.H_DeltaBase = 1.0f;     //0.87f;
  WC_NL.H_DeltaBase = WC_NL_DELTA_025;     //0.87f;
  WC_NL.H_EachBrightLvDelta = 0.0f;
  //Temp//
  WC_NL.T_DeltaBase = 1.4f;     //by field test  + 0.4C @ 18/2021 //1.15f;//roll back @     //2.39f;//(2.4-0.01)//from 3/F box cover        //1.15f;//From 4/F no box
  WC_NL.T_G_EachBrightLvDelta = 0.01f;
  WC_NL.T_Y_EachBrightLvDelta = 0.01f;
  WC_NL.T_X = 0;
  
  //Humidity//
//  WC_FL.H_DeltaBase = 1.0f;     //0.65f;
  WC_FL.H_DeltaBase = WC_FL_DELTA_025;
  WC_FL.H_EachBrightLvDelta = 0.0f;
   //Temp//
//  WC_FL.T_DeltaBase = 1.03f;//by field test @ 18/2021 -1C   //1.12f;
//    WC_FL.T_DeltaBase = 1.07f;//by Steven Jan 18th 2022
      WC_FL.T_DeltaBase = 1.15f;//by Steven Jan 18th 2022
  WC_FL.T_G_EachBrightLvDelta = 0.003f;
  WC_FL.T_Y_EachBrightLvDelta = 0.003f;
  WC_FL.T_X = 0;
  
  //Humidity//
  WC_HL.H_DeltaBase = 1.0f;     //0.7f;
  WC_HL.H_EachBrightLvDelta = 0.0f;

   //Temp//
  WC_HL.T_DeltaBase = 1.07f;
  WC_HL.T_G_EachBrightLvDelta = 0.002f;
  WC_HL.T_Y_EachBrightLvDelta = 0.002f;
  WC_HL.T_X = 0;
  
  
  WC_T_Delta_Smooth_up = 0.001f;
  WC_T_Delta_Smooth_dn = WC_T_Delta_Smooth_up / 4.0f;
  
}

#if defined STM32_ADC_HAL_FUNC
    
/*
 * function ：ADC1_GPIO_Config
 * desc  ：enable ADC1 & DMA1 clock，PC.00
 */
static void ADC1_GPIO_Config(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;
	
	/* Enable DMA clock */
	RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE);
	
	/* Enable ADC1 and GPIOC clock */
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_ADC1 | RCC_APB2Periph_GPIOA, ENABLE);
	
	/* Configure PA.00  as analog input */
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0 | GPIO_Pin_1;          // NTC 1 & 2
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
        //GPIO_InitStruct.Mode = GPIO_MODE_ANALOG;
        GPIO_InitStruct.Pull = GPIO_NOPULL;
	GPIO_Init(GPIOA, &GPIO_InitStructure);				// PC1,输入时不用设置速率
//#ifdef BRNC_ES4
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2;          // NTC 3
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AIN;
        //GPIO_InitStruct.Mode = GPIO_MODE_ANALOG;
        GPIO_InitStruct.Pull = GPIO_NOPULL;
	GPIO_Init(GPIOB, &GPIO_InitStructure);				// PC1,输入时不用设置速率
//#endif
        
}

/* function：ADC1_Mode_Config
 * desc  ：config ADC1 mode MDA
 */
static void ADC1_Mode_Config(void)
{
	DMA_InitTypeDef DMA_InitStructure;
	ADC_InitTypeDef ADC_InitStructure;
	
	/* DMA channel1 configuration */
	DMA_DeInit(DMA1_Channel1);
	DMA_DeInit(DMA1_Channel2);
	DMA_InitStructure.DMA_PeripheralBaseAddr = ADC1_DR_Address;	 //ADC地址
	DMA_InitStructure.DMA_MemoryBaseAddr = (uint32_t)&ADC_ConvertedValue;//内存地址
	DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC;
	DMA_InitStructure.DMA_BufferSize = 1;
	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Disable;//外设地址固定
	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Disable;  //内存地址固定
	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;	//半字
	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;
	DMA_InitStructure.DMA_Mode = DMA_Mode_Circular;		//循环传输
	DMA_InitStructure.DMA_Priority = DMA_Priority_High;
	DMA_InitStructure.DMA_M2M = DMA_M2M_Disable;
	DMA_Init(DMA1_Channel1, &DMA_InitStructure);
	
	/* Enable DMA channel1 */
	DMA_Cmd(DMA1_Channel1, ENABLE);
	DMA_Cmd(DMA1_Channel2, ENABLE);

	/* ADC1 configuration */
	
	ADC_InitStructure.ADC_Mode = ADC_Mode_Independent;	//独立ADC模式
	ADC_InitStructure.ADC_ScanConvMode = DISABLE ; 	 //禁止扫描模式，扫描模式用于多通道采集
	ADC_InitStructure.ADC_ContinuousConvMode = ENABLE;	//开启连续转换模式，即不停地进行ADC转换
	ADC_InitStructure.ADC_ExternalTrigConv = ADC_ExternalTrigConv_None;	//不使用外部触发转换
	ADC_InitStructure.ADC_DataAlign = ADC_DataAlign_Right; 	//采集数据右对齐
	ADC_InitStructure.ADC_NbrOfChannel = 1;	 	//要转换的通道数目1
	ADC_Init(ADC1, &ADC_InitStructure);
	
	
//	RCC_ADCCLKConfig(RCC_PCLK2_Div8);   //config ADC clock，PCLK2->8，=9Hz
	RCC_ADCCLKConfig(RCC_PCLK2_Div6);   //分频因子6时钟为72M/6=12MHz	
	
	/*config ADC1 channel 11 for 55.	5 sampple period，serial=1 */ 
	ADC_RegularChannelConfig(ADC1, ADC_Channel_11, 1, ADC_SampleTime_55Cycles5);
	
	/* Enable ADC1 DMA */
	ADC_DMACmd(ADC1, ENABLE);
	
	/* Enable ADC1 */
	ADC_Cmd(ADC1, ENABLE);
	
	ADC_ResetCalibration(ADC1);
	while(ADC_GetResetCalibrationStatus(ADC1));
	
	ADC_StartCalibration(ADC1);
	while(ADC_GetCalibrationStatus(ADC1));
	
	ADC_SoftwareStartConvCmd(ADC1, ENABLE);
}

void ADC1_Init(void)
{
	ADC1_GPIO_Config();
	ADC1_Mode_Config();
}

uint16_t Temp_getAdc(uint8_t ch)   
{
 
	ADC_RegularChannelConfig(ADC1, ch, 1, ADC_SampleTime_239Cycles5 );	//ADC1,ADC通道3,第一个转换,采样时间为239.5周期	  			    
 
	ADC_SoftwareStartConvCmd(ADC1, ENABLE);		//使能指定的ADC1的软件转换启动功能
	while(!ADC_GetFlagStatus(ADC1, ADC_FLAG_EOC ));//等待转换结束
	
	return ADC_GetConversionValue(ADC1);		//返回最近一次ADC1规则组的转换结果
}

uint16_t Temp_getAdcAverage(uint8_t ch, uint8_t times)
{
	uint32_t temp_val=0;
	uint8_t t;
	for(t=0;t<times;t++)
	{
		temp_val+=Temp_getAdc(ch);
		Delay_ms(5);
	}
	
	return temp_val/times;
} 	   

void Temp_getTemperature(void)
{
    float temp;
    float temperature;
    
    adcx=Temp_getAdcAverage(ADC_CH_TEMP,10);
    temp=(float)adcx*(3.3/4096);
    temperature=temp;//保存温度传感器的电压值								  
    temperature=(1.43-temperature)/0.0043+25;		//计算出当前温度值	 
  
    DEBUG_SENSOR("\r\n get sample = 0x%04X \r\n", adcx); 
    DEBUG_SENSOR("\r\n converted temperature = %f C \r\n",temperature); 
	  
//	ADC_ConvertedValueLocal =(float) ADC_ConvertedValue/4096*3.3; // 读取转换的AD值	
//	printf("\r\n get sample = 0x%04X \r\n", ADC_ConvertedValue); 
//	printf("\r\n value after conversion = %f V \r\n",ADC_ConvertedValueLocal); 
}
#else

static void ADC1_GPIO_Config(void)
{
/*  
	GPIO_InitTypeDef GPIO_InitStruct;
		
	/// Configure PA.00  as analog input ///
	GPIO_InitStruct.GPIO_Pin = GPIO_PIN_0 | GPIO_PIN_1;          // NTC 1 & 2
//	GPIO_InitStruct.GPIO_Mode = GPIO_Mode_AIN;
        GPIO_InitStruct.Mode = GPIO_MODE_ANALOG;
        GPIO_InitStruct.Pull = GPIO_NOPULL;
	GPIO_Init(GPIOA, &GPIO_InitStructure);				// PC1,输入时不用设置速率
*/
    GPIO_InitTypeDef GPIO_InitStruct = {
        .Pin = GPIO_PIN_0 | GPIO_PIN_1,          // NTC 1 & 2,
        .Mode = GPIO_MODE_INPUT,
        .Pull = GPIO_NOPULL,
    };
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);
    
 
}



/**
  * @brief ADC1 Initialization Function
  * @param None
  * @retval None
  */
void MX_ADC1_Init(void)
{

  /* USER CODE BEGIN ADC1_Init 0 */
  
  Init_Cal_Data();
  
    ADC1_GPIO_Config();
    
  /* USER CODE END ADC1_Init 0 */

  ADC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN ADC1_Init 1 */

  /* USER CODE END ADC1_Init 1 */
  /** Configure the global features of the ADC (Clock, Resolution, Data Alignment and number of conversion) 
  */
  hadc1.Instance = ADC1;
  hadc1.Init.ClockPrescaler = ADC_CLOCK_SYNC_PCLK_DIV1;
  hadc1.Init.Resolution = ADC_RESOLUTION_12B;
  hadc1.Init.DataAlign = ADC_DATAALIGN_RIGHT;
  hadc1.Init.ScanConvMode = ADC_SCAN_DIRECTION_FORWARD;
  hadc1.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  hadc1.Init.LowPowerAutoWait = DISABLE;
  hadc1.Init.LowPowerAutoPowerOff = DISABLE;
  hadc1.Init.ContinuousConvMode = DISABLE;
  hadc1.Init.NbrOfConversion = 1;
  hadc1.Init.DiscontinuousConvMode = ENABLE;
  hadc1.Init.ExternalTrigConv = ADC_SOFTWARE_START;
  hadc1.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  hadc1.Init.DMAContinuousRequests = DISABLE;
  hadc1.Init.Overrun = ADC_OVR_DATA_PRESERVED;
  hadc1.Init.SamplingTimeCommon1 = ADC_SAMPLETIME_1CYCLE_5;
  hadc1.Init.SamplingTimeCommon2 = ADC_SAMPLETIME_1CYCLE_5;
  hadc1.Init.OversamplingMode = DISABLE;
  hadc1.Init.TriggerFrequencyMode = ADC_TRIGGER_FREQ_HIGH;
  if (HAL_ADC_Init(&hadc1) != HAL_OK)
  {
    Error_Handler();
  }
  
  if (HAL_ADCEx_Calibration_Start(&hadc1) != HAL_OK)
  {
    Error_Handler();
  }
  
  
  /** Configure Regular Channel 
  */
  sConfig.Channel = ADC_CHANNEL_0;
  sConfig.Rank = ADC_REGULAR_RANK_1;
//  sConfig.SamplingTime = ADC_SAMPLINGTIME_COMMON_1;
  if (HAL_ADC_ConfigChannel(&hadc1, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  
  /* USER CODE BEGIN ADC1_Init 2 */
  sConfig.Channel = ADC_CHANNEL_1;
  sConfig.Rank = ADC_REGULAR_RANK_2;
//  sConfig.SamplingTime = ADC_SAMPLINGTIME_COMMON_1;
  if (HAL_ADC_ConfigChannel(&hadc1, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }    
  /* USER CODE END ADC1_Init 2 */
  
  /* USER CODE BEGIN ADC1_Init 10 */
  sConfig.Channel = ADC_CHANNEL_10;
  sConfig.Rank = ADC_REGULAR_RANK_2;
//  sConfig.SamplingTime = ADC_SAMPLINGTIME_COMMON_1;
  if (HAL_ADC_ConfigChannel(&hadc1, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }    
  /* USER CODE END ADC1_Init 10 */

}

#if defined DMA_TEST_REF
/** 
* Enable DMA controller clock
*/
void MX_DMA_Init(void) 
{
/* DMA controller clock enable */
    __DMA2_CLK_ENABLE();
   

    /* DMA interrupt init */
    /* Sets the priority grouping field */
    HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_0);
    HAL_NVIC_SetPriority(DMA2_Stream0_IRQn, 0, 0);
    HAL_NVIC_EnableIRQ(DMA2_Stream0_IRQn);
}

void Temp_getADCAvgValue(void)
{
// Start ADC DMA 
    HAL_ADC_Start(&hadc1);
    HAL_ADC_Start_DMA(&hadc1, (uint32_t*)adcData, 8);
}
#endif

// ADC DMA interrupt handler
#if DEFINE_ADC_CALLBACK1
void HAL_ADC_ConvCpltCallback( ADC_HandleTypeDef * hadc)
{
    printf("ADC conversion done.\n");
    HAL_ADC_Stop_DMA(hadc);
    HAL_ADC_Stop(hadc);
}
#else
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc)  
{ 
  uint16_t ADC_raw;
  float Vdd;
      
  if (__HAL_ADC_GET_FLAG(hadc, ADC_FLAG_EOC)) 
  { 
    ADC_raw = HAL_ADC_GetValue(hadc); 
    Vdd = 3300 * (*VREFINT_CAL_ADDR)/ADC_raw; 
  } 
  
/*
 if (__HAL_ADC_GET_FLAG(hadc, ADC_FLAG_EOC)) 
  {
  ADC_raw[index] = HAL_ADC_GetValue(hadc); 
  index++;
  }
if (__HAL_ADC_GET_FLAG(hadc, ADC_FLAG_EOS))  
 {
 index=0;
 Vdd = 3300 * (*VREFINT_CAL_ADDR) / ADC_raw[2];
 temperature = (((int32_t)ADC_raw[1] * Vdd/3300)- (int32_t) *TEMP30_CAL_ADDR );
 temperature = temperature * (int32_t)(110 - 30);
 temperature = temperature / (int32_t)(*TEMP110_CAL_ADDR - *TEMP30_CAL_ADDR);
 temperature = temperature + 30; Vin = Vdd*ADC_raw[0]/4095;
 }
*/  
}
#endif

// Define variable to hold the 8 ADC values
// Why 32 bits if the resolution is 12b? 

void NTC_getTempValue(uint8_t inTask)
{
  /* USER CODE BEGIN WHILE */
  /* USER CODE END WHILE */
 
  /* USER CODE BEGIN 3 */
 
      volatile uint16_t rawValue1, rawValue2, rawValue3;
      volatile float temp1, temp2, temp3;
      volatile float temp1_arr[16], temp2_arr[16], temp3_arr[16];
      uint8_t i;

      for (i = 0; i < 1; i++){
        
  #if defined SENSOR_NTC1
        
        HAL_ADC_Start(&hadc1);
        HAL_ADC_PollForConversion(&hadc1, 10);
        rawValue1 = HAL_ADC_GetValue(&hadc1);
        NTC1_rawADCvalue = rawValue1;
        HAL_ADC_Start(&hadc1);
        HAL_ADC_PollForConversion(&hadc1, 10);
        rawValue2 = HAL_ADC_GetValue(&hadc1);
        NTC2_rawADCvalue = rawValue2;
        if (HW_VER == BRNC_ES4_HWVER || HW_VER == BRNC_ES5_HWVER){
              HAL_ADC_Start(&hadc1);
              HAL_ADC_PollForConversion(&hadc1, 10);
              rawValue3 = HAL_ADC_GetValue(&hadc1);
              NTC3_rawADCvalue = rawValue3;
        }
        HAL_ADC_Stop(&hadc1);
        
    #if MURATA_NTC
           //*** this eq is applied to (-40~125C) accuracy at 0.087C ***
          //  x=C/2n - 0.5, where C is adc value
          //  T=25 + x(C1 + x(x2 + xC3))/(1+ x(c4 + xc5))
          temp1 = NTC_MRURATA_NCP18XH103F03RB_cal(rawValue1);
          
    #else      
          temp1 = ((float)rawValue1) / 4096.0f * 3300.0f;
          temp1 = ((temp1 - 760.0f) / 2.5f) + 25.0f;
    #endif
        temp1_arr[i] = temp1;
        NTC_temp1 = temp1;
        DEBUG_SENSOR("NTC1 get sample = 0x%04X \r\n", rawValue1); 
        DEBUG_SENSOR("NTC1 converted temperature = %f C \r\n",NTC_temp1);
  #endif    
        
        
  #if defined SENSOR_NTC2
        
              

        
    #if MURATA_NTC
           //*** this eq is applied to (-40~125C) accuracy at 0.087C ***
          //  x=C/2n - 0.5, where C is adc value
          //  T=25 + x(C1 + x(x2 + xC3))/(1+ x(c4 + xc5))
          temp2 = NTC_MRURATA_NCP18XH103F03RB_cal(rawValue2);
          
    #else      
          temp2 = ((float)rawValue2) / 4096.0f * 3300.0f;
          temp2 = ((temp2 - 760.0f) / 2.5f) + 25.0f;
    #endif
        temp2_arr[i] = temp2;
        NTC_temp2 = temp2;
        DEBUG_SENSOR("NTC2 get sample = 0x%04X \r\n", rawValue2); 
        DEBUG_SENSOR("NTC2 converted temperature = %f C \r\n",temp2);
  #endif    
        
      if (HW_VER == BRNC_ES4_HWVER || HW_VER == BRNC_ES5_HWVER){
        #if MURATA_NTC
               //*** this eq is applied to (-40~125C) accuracy at 0.087C ***
              //  x=C/2n - 0.5, where C is adc value
              //  T=25 + x(C1 + x(x2 + xC3))/(1+ x(c4 + xc5))
              temp3 = NTC_MRURATA_NCP18XH103F03RB_cal(rawValue3);

        #else      
              temp3 = ((float)rawValue3) / 4096.0f * 3300.0f;
              temp3 = ((temp3 - 760.0f) / 2.5f) + 25.0f;
        #endif
            temp3_arr[i] = temp3;
            NTC_temp3 = temp3;
            DEBUG_SENSOR("NTC3 get sample = 0x%04X \r\n", rawValue3); 
            DEBUG_SENSOR("NTC3 converted temperature = %f C \r\n",temp3);
              
        }
      
        
        
//        if (inTask){
//          vTaskDelay(10);
//        }else{
//          HAL_Delay(10);
//        }
        
      }
        
        
//      NTC_temp1 = (temp1_arr[5] + temp1_arr[6] + temp1_arr[7] + temp1_arr[8] + temp1_arr[9] + temp1_arr[10] + temp1_arr[11] + temp1_arr[12]) / 8.0f;
//      NTC_temp2 = (temp2_arr[5] + temp2_arr[6] + temp2_arr[7] + temp2_arr[8] + temp2_arr[9] + temp2_arr[10] + temp2_arr[11] + temp2_arr[12]) / 8.0f;
//      NTC_temp3 = (temp3_arr[5] + temp3_arr[6] + temp3_arr[7] + temp3_arr[8] + temp3_arr[9] + temp3_arr[10] + temp3_arr[11] + temp3_arr[12]) / 8.0f;
      
//      HAL_Delay(1000); //Display updates every second 
}

float NTC_MRURATA_NCP18XH103F03RB_cal(uint16_t reading){
  float temp;
  //reference: http://www..mosaic-industries.com/embedded-systems/microcontroller-projects/temperature-measurement/ntc-thermistors/example-code-equations
#ifdef BROAN_BRNC011
      temp = (((float)reading)/4096.0f) - 0.5f;                      //12 bit
#elif defined(BROAN_BRNC021)
      temp = (((float)reading)/4096.0f) - 0.5f;                      //12 bit
#endif
      //temp = 25.0f + temp*(-108.21f + temp*(24.118f +temp*216.38f))/(1.0f + temp*(0.03895f + temp*(-3.1804f)));
      temp = 25.0f + temp*(-107.27f + temp*(44.12f +temp*217.31f))/(1.0f + temp*(-0.12915f + temp*(-3.3586f)));
      return temp;
}

void Temp_getTemperataure_test(void)
{
  /* USER CODE BEGIN WHILE */

  while (1)
  {
  /* USER CODE END WHILE */
 
  /* USER CODE BEGIN 3 */
 
      volatile uint16_t rawValue;
      volatile float temp;
 

#if defined SENSOR_NTC1
      
      HAL_ADC_Start(&hadc1);      
      HAL_ADC_PollForConversion(&hadc1, HAL_MAX_DELAY);
      rawValue = HAL_ADC_GetValue(&hadc1);
      HAL_ADC_Stop(&hadc1);
      
      temp = ((float)rawValue) / 4095.0f * 3300.0f;
      temp = ((temp - 760.0f) / 2.5f) + 25.0f;

      DEBUG_SENSOR("NTC1 get sample = 0x%04X \r\n", rawValue); 
      DEBUG_SENSOR("NTC1 converted temperature = %f C \r\n",temp);
#endif    
//      HAL_Delay(1000); //Display updates every second 
  }
}  


float GetNTCTemp1(void){
  return NTC_temp1;
}

float GetNTCTemp2(void){
  return NTC_temp2;
}

float GetNTCTemp3(void){
  return NTC_temp3;
}

uint16_t GetNTC1_rawADCvalue(void){
  return NTC1_rawADCvalue;
}

uint16_t GetNTC2_rawADCvalue(void){
  return NTC2_rawADCvalue;
}

uint16_t GetNTC3_rawADCvalue(void){
  return NTC3_rawADCvalue;
}

float GetOutDelta_data(void){
  return OutDelta_data;
}


float CalTemperature(float RawTemperature, float NTC1temp, float NTC2temp, uint8_t IAQvalue, GPIO_PinState Btn1_OnOff, GPIO_PinState Btn2_OnOff, uint8_t IAQ_Intensity_value){
  
  
  
  float resTemp = -1;

  float NTC_CaledData = -1;

  //int ambTempRaw, humidityRaw, ambTempReal, pressureReal;  
  float LukeDelta = -1;
  float X = 0;
  // NTC2temp is NTC3
  
    NTC1_SmoothSample = NTC1_SMOOTH_SAMPLE_SIZE;
    TempDelta_SmoothSample = TEMP_DELTA_SMOOTH_SAMPLE_SIZE;
    
    if (NTC1temp < -40 || NTC1temp > 125)
      return 0;
    
    if (NTC2temp < 10 || NTC2temp > 60)
      return 0;
  
    NTC_CaledData = NTC1temp - (NTC2temp - 25);
    
    if (NTC_CaledData_last != 0 && NTC_CaledData != -1){
      NTC_CaledData = (NTC_CaledData_last * (NTC1_SmoothSample - 1.0f) + NTC_CaledData) / NTC1_SmoothSample;
    }
    
    if (IAQvalue == IAQ_NONE){
      IAQ_Intensity_value = 1;
    }

    
#ifdef BROAN_BRNC021

      if (IAQvalue == IAQ_NONE || IAQvalue == IAQ_GREEN || IAQvalue == IAQ_RED || IAQvalue == IAQ_BLUE){
        if (Btn1_OnOff == GPIO_PIN_SET && Btn2_OnOff == GPIO_PIN_SET){
          LukeDelta = (WC_FL.T_G_EachBrightLvDelta * (10.0f - (float)IAQ_Intensity_value)) + WC_FL.T_DeltaBase;
          X = WC_FL.T_X;  
          Loading_Status_forTHcal = LOADING_STATUS_2L;          
        }else if (Btn1_OnOff == GPIO_PIN_SET || Btn2_OnOff == GPIO_PIN_SET){
          LukeDelta = (WC_HL.T_G_EachBrightLvDelta * ((float)IAQ_Intensity_value)) + WC_HL.T_DeltaBase;
          X = WC_HL.T_X;  
          Loading_Status_forTHcal = LOADING_STATUS_1L;
        }else{
          LukeDelta = (WC_NL.T_G_EachBrightLvDelta * (11.0f - (float)IAQ_Intensity_value)) + WC_NL.T_DeltaBase;
          X = WC_NL.T_X;          
          Loading_Status_forTHcal = LOADING_STATUS_NL;
        }
        
      }else if (IAQvalue == IAQ_YELLOW || IAQvalue == IAQ_ORANGE){
        if (Btn1_OnOff == GPIO_PIN_SET && Btn2_OnOff == GPIO_PIN_SET){
          LukeDelta = (WC_FL.T_Y_EachBrightLvDelta * (10.0f - (float)IAQ_Intensity_value)) + WC_FL.T_DeltaBase;
           X = WC_FL.T_X;  
           Loading_Status_forTHcal = LOADING_STATUS_2L;
        }else if (Btn1_OnOff == GPIO_PIN_SET || Btn2_OnOff == GPIO_PIN_SET){
          LukeDelta = (WC_HL.T_Y_EachBrightLvDelta * ((float)IAQ_Intensity_value)) + WC_HL.T_DeltaBase;
          X = WC_HL.T_X;  
          Loading_Status_forTHcal = LOADING_STATUS_1L;
        }else{
          LukeDelta = (WC_NL.T_Y_EachBrightLvDelta * (11.0f - (float)IAQ_Intensity_value)) + WC_NL.T_DeltaBase;
          X = WC_NL.T_X;
          Loading_Status_forTHcal = LOADING_STATUS_NL;
        }
        
      }
    
          if (TempDelta_last != 0 && LukeDelta != -1){
//            if (ThreeSecTick >= 4){
//              ThreeSecTick = 0;

              if (Target_LukeDelta != LukeDelta){
                Target_LukeDelta = LukeDelta;
              }
              //printf("1. Target_Delta = %0.3f, curr TempDelta_last = %0.3f\r\n", Target_LukeDelta, TempDelta_last);
              if (TempDelta_last < Target_LukeDelta ){
                LukeDelta = TempDelta_last + WC_T_Delta_Smooth_dn;
              }else if (TempDelta_last > Target_LukeDelta){
                LukeDelta = TempDelta_last - WC_T_Delta_Smooth_up;
              }else{
                LukeDelta = Target_LukeDelta;
              }
              
              
//            }
            
            
            
//            if (Loading_Status_forTHcal_B4 != Loading_Status_forTHcal){
//              Loading_Status_forTHcal_B4 = Loading_Status_forTHcal;
//              Target_LukeDelta = LukeDelta;
//              
//            }else{
//              LukeDelta = (TempDelta_last * (TempDelta_SmoothSample - 1.0f) + LukeDelta) / TempDelta_SmoothSample;
//              Curr_LukeDelta = LukeDelta;
//            }
          }
          TempDelta_last = LukeDelta;
          OutDelta_data = LukeDelta;
    //=(0.01*(11-T2))+1.15

#elif defined(BROAN_BRNC011)
    


        if (IAQvalue == IAQ_NONE || IAQvalue == IAQ_GREEN || IAQvalue == IAQ_RED || IAQvalue == IAQ_BLUE){
          if (Btn1_OnOff == GPIO_PIN_SET){              //15A FL
            LukeDelta = (RS_FL.T_G_EachBrightLvDelta * ((float)IAQ_Intensity_value)) + RS_FL.T_DeltaBase;
            X = RS_FL.T_X;
            Loading_Status_forTHcal = LOADING_STATUS_1L;
          }else{                                        //NL 
            LukeDelta = (RS_NL.T_G_EachBrightLvDelta * ((float)IAQ_Intensity_value)) + RS_NL.T_DeltaBase;
            X = RS_NL.T_X;
            Loading_Status_forTHcal = LOADING_STATUS_NL;
          }
        }else if (IAQvalue == IAQ_YELLOW || IAQvalue == IAQ_ORANGE){
          if (Btn1_OnOff == GPIO_PIN_SET){              //15A FL
            LukeDelta = (RS_FL.T_Y_EachBrightLvDelta * ((float)IAQ_Intensity_value)) + RS_FL.T_DeltaBase;
            X = RS_FL.T_X;
            Loading_Status_forTHcal = LOADING_STATUS_1L;
          }else{                                         //NL 
            LukeDelta = (RS_NL.T_Y_EachBrightLvDelta * ((float)IAQ_Intensity_value)) + RS_NL.T_DeltaBase;
            X = RS_NL.T_X;
            Loading_Status_forTHcal = LOADING_STATUS_NL;
          }
        }
        if (TempDelta_last != 0 && LukeDelta != -1){
          LukeDelta = (TempDelta_last * (TempDelta_SmoothSample - 1.0f) + LukeDelta) / TempDelta_SmoothSample;
        }
        TempDelta_last = LukeDelta;
        
#endif
      
//          if (TempDelta_last != 0 && LukeDelta != -1){
//            LukeDelta = (TempDelta_last * (TempDelta_SmoothSample - 1.0f) + LukeDelta) / TempDelta_SmoothSample;
//          }
    
          resTemp = (RawTemperature - X) - (NTC_CaledData - RawTemperature)/LukeDelta;

          NTC_CaledData_last = NTC_CaledData;
          
          Temp_backup = resTemp;
          //printf("011,resTemp:%0.2f,RawTemperature:%0.2f,NTC_CaledData:%0.2f,LukeDelta:%0.3f,NTC1temp:%0.2f,NTC2temp:%0.2f,NTC1_SmoothSample:%0.2f,TempDelta_SmoothSample:%0.2f,IAQ_Intensity_value:%d\r\n", resTemp,RawTemperature,NTC_CaledData,LukeDelta,NTC1temp,NTC2temp,NTC1_SmoothSample,TempDelta_SmoothSample,IAQ_Intensity_value);
          
          return resTemp;
      
}  


float CalHumidity(float RawHumidity, float RawTemp, float RealTemp, float NTC3temp, uint8_t IAQ_Intensity_value, GPIO_PinState Btn1_OnOff, GPIO_PinState Btn2_OnOff){
  float resHumidity = -1;
  float pressureRaw;
  float humidityRaw, pressureReal, ambTempRaw, ambTempReal;
  uint16_t arraryPos;
  
  float Special_Offset = 1.0f;
  
  humidityRaw = RawHumidity * 100;
  ambTempReal = RealTemp * 100;
  ambTempRaw = RawTemp * 100;
  
    if (NTC3temp < 10 || NTC3temp > 60)
      return 0;
  
  Special_Offset = 1.0f;
#ifdef BROAN_BRNC021
    #ifdef HUMIDIY_ADD_DELTA
      if (Btn1_OnOff == GPIO_PIN_SET && Btn2_OnOff == GPIO_PIN_SET){
        if(Temp_backup > 26)
        WC_FL.H_DeltaBase = WC_FL_DELTA_2535;
      else
        WC_FL.H_DeltaBase = WC_FL_DELTA_025;
        Special_Offset = WC_FL.H_DeltaBase - (IAQ_Intensity_value * WC_FL.H_EachBrightLvDelta);
//        Special_Offset = 2640;
      }else if (Btn1_OnOff == GPIO_PIN_SET || Btn2_OnOff == GPIO_PIN_SET){
        if(Temp_backup > 26)
        WC_HL.H_DeltaBase = WC_HL_DELTA_2535;
      else
        WC_HL.H_DeltaBase = WC_HL_DELTA_025;
        Special_Offset = WC_HL.H_DeltaBase - (IAQ_Intensity_value * WC_HL.H_EachBrightLvDelta);
      }else{
        if(Temp_backup > 26)
        WC_NL.H_DeltaBase = WC_NL_DELTA_2535;
      else
        WC_NL.H_DeltaBase = WC_NL_DELTA_025;
        Special_Offset = WC_NL.H_DeltaBase - (IAQ_Intensity_value * WC_NL.H_EachBrightLvDelta);
      }
    #endif
    
#endif
  
  
#ifdef BROAN_BRNC011
  #ifdef HUMIDIY_ADD_DELTA
    if (Btn1_OnOff == GPIO_PIN_SET){
      if(Temp_backup > 26)
        RS_FL.H_DeltaBase = RS_FL_DELTA_2535;
      else
        RS_FL.H_DeltaBase = RS_FL_DELTA_025;
      Special_Offset = RS_FL.H_DeltaBase - (IAQ_Intensity_value * RS_FL.H_EachBrightLvDelta);
    }else{
      if(Temp_backup > 26)
        RS_NL.H_DeltaBase = RS_NL_DELTA_2535;
      else
        RS_NL.H_DeltaBase = RS_NL_DELTA_025;
      Special_Offset = RS_NL.H_DeltaBase - (IAQ_Intensity_value * RS_NL.H_EachBrightLvDelta);
    }
  #endif
#endif
  
  DEBUG_SENSOR("humidityRaw : %f, ambTempReal = %d, ambTempRaw = %d \r\n", humidityRaw,ambTempReal, ambTempRaw);
  
                        if (ambTempRaw < 0) {
                              pressureRaw = saturational_pressure_table[0];
                        } else if (ambTempRaw > 5000) {
                              pressureRaw = saturational_pressure_table[500];
                        } else {
                              arraryPos = (uint16_t)((ambTempRaw + 5) / 10);
                              pressureRaw = saturational_pressure_table[arraryPos];
                        }

                        if (ambTempReal < 0) {
                              pressureReal = saturational_pressure_table[0];
                        } else if (ambTempReal > 5000) {
                              pressureReal = saturational_pressure_table[500];
                        } else {
                              arraryPos = (uint16_t)((ambTempReal + 5) / 10);
                              pressureReal = saturational_pressure_table[arraryPos];
                        }
                        
       
                        
                        resHumidity = RawHumidity * ((pressureRaw*1.0f) / (pressureReal*1.0f)) * Special_Offset;

    
    
    if (resHumidity < 0.0f){
      resHumidity = 0.0f;
    }else if (resHumidity > 100.0f){
      resHumidity = 100.0f;
    }
    
     DEBUG_SENSOR("pressureReal = %d, pressureRaw = %d,Special_Offset=%f \r\n",pressureReal, pressureRaw,Special_Offset);
     
      
  
  return resHumidity;
}

#endif
